name: Track New Repos with Tags

on:
  schedule:
    - cron: '0 14 * * *'
  workflow_dispatch:
  watch:
    types: [started]

jobs:
  create-tags:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  
        ref: main     

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install requests pygithub

    - name: Get new repositories and create tags
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        import os
        import requests
        from datetime import datetime, timedelta

        def get_new_repos():
            created_date = (datetime.now() - timedelta(days=300)).strftime("%Y-%m-%d")
            url = f"https://api.github.com/search/repositories?q=created:>={created_date}+stars:>2+is:public&sort=updated&order=desc&per_page=5000"
            headers = {
                'Accept': 'application/vnd.github.v3+json',
                'Authorization': f"token {os.environ['GITHUB_TOKEN']}"
            }
            
            response = requests.get(url, headers=headers)
            if response.status_code != 200:
                raise Exception(f"badAPI: {response.status_code} - {response.text}")
                
            repos = response.json().get('items', [])
            return [(repo['owner']['login'], repo['name']) for repo in repos]

        repo_data = get_new_repos()
        print(f"Found {len(repo_data)} new repositories")

        timestamp = datetime.now().strftime("%Y%m%d")

        for i, (username, repo_name) in enumerate(repo_data[:2000]):  
            email = f"{username}@users.noreply.github.com"  
            tag_name = f"new/{repo_name.replace('/', '-')}/{timestamp}-{i}"  
            
            print(f"Processing {username}/{repo_name}")

            os.system(f'''
            export GIT_AUTHOR_NAME="{username}"
            export GIT_AUTHOR_EMAIL="{email}"
            export GIT_COMMITTER_NAME="GitHub Actions"
            export GIT_COMMITTER_EMAIL="{email}"
            git commit --allow-empty -m "Track new repo: {username}/{repo_name}"
            ''')
            
            os.system(f'git tag {tag_name}')
            
            print(f"Created tag {tag_name}")

        os.system(f"git push origin main")
        os.system("git push origin --tags")
      shell: python
